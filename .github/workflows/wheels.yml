name: Build and Publish Binary Wheels

on:
  release:
    types: [published]  # Trigger when a release is published
  workflow_dispatch:    # Allow manual triggering
    inputs:
      version:
        description: 'Version to use for manual triggering (e.g., 1.0.0)'
        required: true
        default: '0.0.1-dev'
      pypi_repo:
        description: 'PyPI repository to upload to (pypi or testpypi)'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - pypi
          - testpypi

jobs:
  build_wheels:
    runs-on: ${{ matrix.os.runner }}
    strategy:
      matrix:
        os:
          - { runner: ubuntu-latest, container: 'quay.io/pypa/manylinux_2_28_x86_64', name: manylinux }
          - { runner: windows-latest, container: '', name: windows }
          - { runner: macos-latest, container: '', name: macos, arch: x86_64 }
          - { runner: macos-latest, container: '', name: macos, arch: arm64 }
        python-version: ['3.11', '3.12', '3.13']
    container: ${{ matrix.os.container }}
    steps:
      - name: Checkout PenRed repository
        uses: actions/checkout@v2

      - name: Extract version from release tag or manual input
        id: version
        shell: bash
        run: |
          # If triggered by a release, extract version from the tag
          if [[ "$GITHUB_EVENT_NAME" == "release" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # For manual triggers, use the provided input
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Detect macOS version
        if: matrix.os.name == 'macos'
        id: detect_macos_version
        shell: bash
        run: |
          # Get the macOS version (e.g., "14.7.4")
          MACOS_VERSION=$(sw_vers -productVersion)
          # Extract the major version (e.g., "14_0")
          MACOS_VERSION_SIMPLE=$(echo "$MACOS_VERSION" | awk -F. '{print $1"_0"}')
          echo "Detected macOS version: $MACOS_VERSION"
          echo "Simplified macOS version: $MACOS_VERSION_SIMPLE"
          echo "macos_version=${MACOS_VERSION_SIMPLE}" >> $GITHUB_OUTPUT

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build PenRed and Python bindings
        env:
          PENRED_VERSION: ${{ steps.version.outputs.version }}
        shell: bash
        run: |
          mkdir src/build
          cd src/build
          if [[ "${{ matrix.os.name }}" == "manylinux" ]]; then
            # Format the Python version (e.g., "3.11" -> "311")
            PYTHON_VERSION=$(echo "${{ matrix.python-version }}" | tr -d '.')
            PYTHON_EXECUTABLE="/opt/python/cp${PYTHON_VERSION}-cp${PYTHON_VERSION}/bin/python"
          else
            # Use the host's Python interpreter for non-container jobs
            PYTHON_EXECUTABLE=$(which python3 || which python)
          fi

          # Set architecture-specific flags for macOS
          if [[ "${{ matrix.os.name }}" == "macos" ]]; then
            echo "Building for macosx arch ${{ matrix.os.arch }}"
            ARCH_FLAGS="-DCMAKE_OSX_ARCHITECTURES=${{ matrix.os.arch }}"
          else
            ARCH_FLAGS=""
          fi          
          
          cmake $ARCH_FLAGS -DWITH_NATIVE="OFF" -DBUILD_TESTS=OFF -DBUILD_UTILITIES=OFF -DBUILD_PYTHON_MODULES=ON -DWITH_DICOM=ON -DWITH_MULTI_THREADING=ON -DPython3_EXECUTABLE=$PYTHON_EXECUTABLE ../
          cmake --build . --config Release --target install -j 4

      - name: Build wheels
        env:
          PENRED_VERSION: ${{ steps.version.outputs.version }}      
        shell: bash
        run: |
          cd src/bindings/python/pyPenred
          if [[ "${{ matrix.os.name }}" == "manylinux" ]]; then
            # Format the Python version (e.g., "3.11" -> "311")
            PYTHON_VERSION=$(echo "${{ matrix.python-version }}" | tr -d '.')
          
            # Use the container's Python interpreter for manylinux
            /opt/python/cp${PYTHON_VERSION}-cp${PYTHON_VERSION}/bin/python -m pip install --upgrade pip
            /opt/python/cp${PYTHON_VERSION}-cp${PYTHON_VERSION}/bin/python -m pip wheel . --wheel-dir wheelhouse
          else
            # Use the host's Python interpreter for non-container jobs
            python -m pip install --upgrade pip
            if [[ "${{ matrix.os.name }}" == "macos" ]]; then
              # Use the detected macOS version in the platform tag              
              python setup.py bdist_wheel --dist-dir wheelhouse --plat-name macosx_${{ steps.detect_macos_version.outputs.macos_version }}_${{ matrix.os.arch }}
            else
              # For Windows, let pip automatically set the platform tag
              python -m pip wheel . --wheel-dir wheelhouse
            fi
          fi
          rm wheelhouse/PyYAML-*.whl

      - name: Repair wheels with auditwheel
        shell: bash
        if: matrix.os.name == 'manylinux'  # Only repair Linux wheels
        run: |
          PYTHON_VERSION=$(echo "${{ matrix.python-version }}" | tr -d '.')
          cd src/bindings/python/pyPenred/wheelhouse
          /opt/python/cp${PYTHON_VERSION}-cp${PYTHON_VERSION}/bin/python -m pip install auditwheel
          /opt/python/cp${PYTHON_VERSION}-cp${PYTHON_VERSION}/bin/python -m auditwheel repair *.whl --plat manylinux_2_28_x86_64 -w .
          # Remove the original wheel
          rm pypenred-*-linux_x86_64.whl          

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os.name }}-${{ matrix.python-version }}
          path: src/bindings/python/pyPenred/wheelhouse/*.whl

  upload_pypi:
    runs-on: ubuntu-latest
    needs: build_wheels
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheelhouse

      - name: Combine wheels into a single directory
        run: |
          mkdir -p combined_wheels
          cp wheelhouse/*/*.whl combined_wheels/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ github.event.inputs.pypi_repo == 'pypi' && secrets.PYPI_API_TOKEN || secrets.TEST_PYPI_API_TOKEN }}
          repository-url: ${{ github.event.inputs.pypi_repo == 'pypi' && 'https://upload.pypi.org/legacy/' || 'https://test.pypi.org/legacy/' }}
          packages-dir: combined_wheels
          verbose: true  # Enable verbose logging
          skip-existing: true  # Skip if the version already exists
